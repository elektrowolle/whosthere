<!DOCTYPE html>
<html>
<head>
	<title>{$title}</title>
	
	<link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300' rel='stylesheet' type='text/css'>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.js"></script>
	<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.css" />
	<link href="style.css" type="text/css" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="mobile-web-app-capable" content="yes">

{if="isKioskMode()"}
	<script src="js/ipUtils.js"></script>
{/if}
</head>

<body>

<div data-role="page" id="page">
	
	<h1>{$title}</h1>
	<p>{$_welcome}</p>
	{if="isKioskMode()"}
	<div id="kioskInfo"></div>
	{/if}
	<h2>{$_todays_arrivals}</h2>
	<div id="todays_arrivals_list">
	{"today_arrivals"|setTplMessage}
	{include="arrivalList"}
	</div>


	<div id="statusContainer">
{if="!isKioskMode()"}
	
	{if="!isCheckedIn()"}
	{include="checkInForm"}
	{/if}

	{if="isCheckedIn()"}

	{/if}

	{if="isArrived()"}

	{/if}
{/if}
{if="isKioskMode()"}
	<h2>Install the app or Check in!</h2>
	<span id="appCheckInUrl">{$app_checkin_url|goo_gl}</span>
	<img src="https://api.qrserver.com/v1/create-qr-code/?color=000000&bgcolor=FFFFFF&data={$app_checkin_url|urlencode}&qzone=1&margin=0&size=400x400&ecc=L" alt="" title="" />
{/if}

	</div>

	<h2>{$_former_arrivals}</h2>
	<div id="former_arrivals_list">
	{"former_arrivals"|setTplMessage}
	{include="arrivalList"}
	</div>
</div>

<script type="text/javascript">

	var user_position = "{$default_position}";
	var last_Update   = "{$initial_time}";
	var api_adrress   = "{$api_address}";

{if="isKioskMode()"}
	var ipShown = false;
{/if}

{if="locationIsNeeded()"}
	if(navigator.geolocation){
		navigator.geolocation.getCurrentPosition(successCallback,errorCallback,{timeout:10000});

		function successCallback (position) {
			user_position = 
				position.coords.latitude 
				+ "," 
				+ position.coords.longitude ;
		}

		function errorCallback (events) {
		}
	}
{/if}

	var posting;
	function update () {
		console.debug("Start update");
		
		
		getNewArrivals();
		getFormerArrivals();
		
		{if="isKioskMode()"}
		$.getJSON(api_adrress + "?get=kiosk&args=showIP&output=json", function(data){
			ipShown = displayIP(data.enabled == "true", ipShown);
			console.debug("Kiosk Infos updated");
		});
		{/if}

		console.debug("Display updated");
	}

	function getNewArrivals () {
		var $todaysList = $("#todays_arrivals_list");
		var requestAddress = api_adrress + "?get=arrivals";
		console.debug("Ask: " + requestAddress);

		$.ajax(api_adrress + "?get=arrivals")
			.done(function(data) {
			    $todaysList.html(data);
			    console.debug("Got new arrivals");
		})
	}

	function getFormerArrivals () {
		var $formerList = $("#former_arrivals_list");
		var args    = JSON.stringify({"filter": "former"});
		var requestAddress = api_adrress + "?get=arrivals&args=" + args;
		
		console.debug("Ask: " + requestAddress);
		$.ajax(requestAddress)
			.done(function(data) {
			    $formerList.html(data);
			    console.debug("Got former arrivals");
		 });
	}

	////// Announcement
	
	var $nameFied = $( "#announceForm" ).find( "input[name='name']" );

	$nameFied.focusin(function( event ) {
		if ($nameFied.val() == "{$_name_request}") {
			$nameFied.val("");
		}
	});

	$nameFied.focusout(function( event ) {
		if ($nameFied.val() == "") {
			$nameFied.val("{$_name_request}");
		}
	});

	$( "#announceForm" ).submit(function( event ) {
 	  console.debug("Transmit Name");
	  // Stop form from submitting normally
	  event.preventDefault();
	 
	  // Get some values from elements on the page:
	  var $form = $( this ),
	    name = $form.find( "input[name='name']" ).val(),
	    url  = $form.attr( "action" );
	 
	  // Send the data using post
	  posting = $.post( url, { name: name, location: user_position } );
	 
	  // Put the results in a div
	  posting.done(function( data ) {
	    $( "#statusContainer" ).html(data);
	    update();
	  });
	});	

	function gup( name ){
		name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
		
		var regexS  = "[\\?&]"+name+"=([^&#]*)";
		var regex   = new RegExp( regexS );
		var results = regex.exec( window.location.href ); 
		
		if( results == null ) 
			return "";
		else 
			return results[1];
	}


	setInterval(update, 5000);
</script>
</body>
</html>
